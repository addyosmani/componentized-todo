<!-- Other dependencies -->
<link rel="import" href="../todo-item/component.html">

<!-- HTML -->
<!-- (moved to index.html) -->

<!-- Interaction -->

<script>
  (function(document){

    var TodoAppController = function(context){
      // save the context to the custom element
      this.context = context;

      // Create an empty collection for the todo items
      // or load existing todos from localStorage
      this.collection = JSON.parse(localStorage.getItem('todos')) || [];

      // Create a shadow root
      this.shadow = this.context.createShadowRoot();

      // stamp out our template in the shadow dom
      var template = document.querySelector("#todo-app-template").content.cloneNode(true);
      this.shadow.appendChild(template);

      // Setup event listener
      this.setupListeners();

      // Initial render of the list
      this.renderList();
    };

    TodoAppController.prototype.setupListeners = function(){
      // Get a reference to the input field inside our shadow DOM
      var input = this.shadow.querySelector("input.new-item");

      // Attach a event listener to our input element
      input.addEventListener('keydown', function(e){

        if(e.which == 13){ // return key hit
          if(input.value.trim() == "") return;

          // Add our item
          this.addItem(input.value);

          // Empty our input view
          input.value = "";
        }

      }.bind(this));
    };

    TodoAppController.prototype.addItem = function(title, done){
      if(!done) done = false;

      // Define a item model
      var itemModel = {title: title, done: done};

      // Add itemModel to the beginning of our collection
      this.collection.unshift(itemModel);

      // trigger event
      var addedEvent = new CustomEvent('added', itemModel);
      this.context.dispatchEvent(addedEvent);

      // Re-render the todo list
      this.renderList();
    };

    TodoAppController.prototype.renderList = function(){
      // Note: renderList() can be significantly optimized. Leaving
      // as a Todo for now.

      // Get a reference to the todo container within the shadow DOM
      var todoContainer = this.shadow.querySelector(".todo-container");
      var self = this;

      // Clear current content
      while(todoContainer.firstChild){
        todoContainer.removeChild(todoContainer.firstChild)
      }

      // Render new items
      for(var i=0; i < this.collection.length; i++){
        // let document create a new item tag
        var todoItem = document.createElement('todo-item');

        // Set the content of the tag
        todoItem.innerHTML = this.collection[i].title;
        // Set the done state of the todo item
        todoItem.shadowRoot.querySelector('input').checked = this.collection[i].done;
        todoItem.id = i;

        // Event handlers for todo items
        todoItem.addEventListener('click', function(e){
          var entry = self.collection[this.id];
          var done = this.shadowRoot.querySelector('input').checked;
          entry.done = done;
          self.collection[this.id] = entry;
          localStorage.setItem('todos', JSON.stringify(self.collection));
        });

        // Append child to the container inside the shadow dom
        todoContainer.appendChild(todoItem);
      }

      localStorage.setItem('todos', JSON.stringify(this.collection));
    };

    // Register the element in the document
    var TodoApp = Object.create(HTMLElement.prototype);
    TodoApp.createdCallback = function(){
      this.controller = new TodoAppController(this);
    };

    // Register our todo-item tag with the document
    document.registerElement('todo-app', {prototype: TodoApp});

  })(document);
</script>
